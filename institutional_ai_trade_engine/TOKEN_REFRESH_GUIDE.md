# 🔄 FYERS Token Refresh - Complete Guide

## Overview

This guide explains how automatic token refresh works in the Institutional AI Trade Engine, enabling **30 days of autonomous operation** with FYERS broker.

---

## 🔑 Token Lifecycle

### FYERS API v3 Token Types

| Token Type | Purpose | Validity | Renewal Method |
|------------|---------|----------|----------------|
| **Authorization Code** | OAuth redirect callback | 30 seconds | One-time use |
| **Access Token** | API requests (data, orders, positions) | **12 hours** | Via refresh token |
| **Refresh Token** | Token renewal | **30 days** | Manual OAuth |

### The Problem

Without automatic refresh, your trading engine would:
- ❌ Stop working after 12 hours
- ❌ Require daily manual token renewal
- ❌ Miss trading opportunities overnight
- ❌ Be unsuitable for production deployment

### The Solution

With automatic refresh:
- ✅ Runs autonomously for **30 days**
- ✅ Only **1 manual renewal per month**
- ✅ Refreshes daily at **08:45 IST** (before market hours)
- ✅ Zero downtime during refresh
- ✅ Automatic .env file updates

---

## 🚀 Initial Setup (One-Time)

### Step 1: Get FYERS Credentials

1. Visit: https://myapi.fyers.in/dashboard/
2. Create a new app (if you haven't already)
3. Note your **Client ID** and **Secret Key**

### Step 2: Generate Tokens via OAuth

You need to complete the OAuth flow **once** to get both tokens:

```bash
# Option 1: Use FYERS Developer Portal
1. Login to https://myapi.fyers.in
2. Go to "Generate Access Token"
3. Complete OAuth authentication
4. Copy both access_token and refresh_token

# Option 2: Use your app's OAuth endpoint
1. Visit your app's auth URL (generated by engine)
2. Login with FYERS credentials
3. Grant permissions
4. Extract tokens from callback response
```

### Step 3: Configure Environment

Add the tokens to your `.env` file:

```env
# FYERS Configuration
FYERS_CLIENT_ID=YOUR_CLIENT_ID_HERE
FYERS_SECRET_KEY=YOUR_SECRET_KEY_HERE
FYERS_ACCESS_TOKEN=YOUR_ACCESS_TOKEN_HERE
FYERS_REFRESH_TOKEN=YOUR_REFRESH_TOKEN_HERE  # ← Critical for auto-refresh!
FYERS_REDIRECT_URI=http://localhost:8000/callback
FYERS_SANDBOX=true  # true for paper trading, false for live
```

**Important**: The `FYERS_REFRESH_TOKEN` is essential for automatic renewal!

### Step 4: Verify Setup

```bash
# Test token validity
python -m src.data.fyers_refresh --test

# Expected output:
# Token Status: {'status': 'valid', 'message': 'Current token is valid'}
```

---

## 🔄 How Automatic Refresh Works

### Daily Refresh Schedule

The system automatically refreshes your access token:
- **When**: Every weekday at **08:45 IST**
- **Why**: Before market hours (09:15 IST)
- **How**: Using the refresh token to get a new access token
- **Duration**: Takes ~1-2 seconds

### Refresh Process

```
08:45:00 IST - Job triggers
08:45:01 IST - Check current token validity
08:45:02 IST - Call FYERS API to refresh
08:45:03 IST - Receive new access token
08:45:04 IST - Update .env file automatically
08:45:05 IST - Log success message
08:45:06 IST - Resume normal operation
```

### What Gets Updated

The refresh process automatically:
1. ✅ Generates new access token (12-hour validity)
2. ✅ Updates `FYERS_ACCESS_TOKEN` in .env file
3. ✅ Updates environment variable in running process
4. ✅ Logs success with timestamp
5. ✅ Continues trading without interruption

---

## 📊 Monitoring Token Refresh

### Log Messages

**Successful Refresh**:
```
================================================================================
🔄 FYERS TOKEN REFRESH - Scheduled Daily Maintenance
================================================================================
⏰ Time: 2025-10-21 08:45:00 IST
📊 Current token status: Current token is valid
================================================================================
✅ TOKEN REFRESH SUCCESSFUL
================================================================================
   New access token: eyJ0eXAiOiJKV1QiLCJ...
   Token valid for: 12 hours
   Next refresh: Tomorrow 08:45 IST
================================================================================
```

**Failed Refresh** (e.g., refresh token expired):
```
================================================================================
❌ TOKEN REFRESH FAILED
================================================================================
   Error: Refresh token expired
   System will continue with MockExchange until resolved
================================================================================
```

### Checking Token Status

```bash
# Check if token is valid
python -m src.data.fyers_refresh --test

# Manually trigger refresh (testing)
python -m src.data.fyers_refresh
```

---

## 🛠️ Manual Renewal (Once Every 30 Days)

When the refresh token expires (after 30 days), you'll need to manually renew:

### Indicators

You'll know renewal is needed when you see:
```
🔑 FYERS REFRESH TOKEN EXPIRED - MANUAL RENEWAL REQUIRED 🔑
❌ Your FYERS refresh token has expired (30-day validity)
```

### Renewal Steps

**For Local Development**:
1. Visit: https://myapi.fyers.in/dashboard/
2. Login with your FYERS credentials
3. Go to "Generate Access Token"
4. Complete OAuth authentication
5. Copy both tokens:
   - `access_token` (12-hour validity)
   - `refresh_token` (30-day validity)
6. Update `.env` file:
   ```env
   FYERS_ACCESS_TOKEN=new_access_token_here
   FYERS_REFRESH_TOKEN=new_refresh_token_here
   ```
7. Restart the engine
8. ✅ Good for another 30 days!

**For Production (Render/Railway)**:
1. Generate new tokens (steps 1-5 above)
2. Go to Render/Railway dashboard
3. Update environment variables:
   - `FYERS_ACCESS_TOKEN` = new access token
   - `FYERS_REFRESH_TOKEN` = new refresh token
4. Restart the web service
5. ✅ Autonomous operation resumed!

---

## 🔧 Troubleshooting

### Problem: Token refresh fails

**Symptoms**:
- Error in logs: "Token refresh failed"
- System falls back to MockExchange

**Solutions**:
1. **Check refresh token**: Ensure `FYERS_REFRESH_TOKEN` is set in .env
2. **Verify not expired**: Refresh tokens last 30 days
3. **Check credentials**: Ensure `FYERS_CLIENT_ID` and `FYERS_SECRET_KEY` are correct
4. **Manual renewal**: If 30 days passed, follow manual renewal steps above

### Problem: .env file not updating

**Symptoms**:
- Refresh succeeds but old token still in .env
- Next day, token is invalid again

**Solutions**:
1. **Check file permissions**: .env should be writable
   ```bash
   chmod 644 .env
   ```
2. **Check file location**: Ensure .env is in project root
3. **Manual update**: Update .env manually if auto-update fails

### Problem: Token valid but API calls fail

**Symptoms**:
- Token refresh shows success
- API returns 401 Unauthorized

**Solutions**:
1. **Restart application**: New token might not be loaded
2. **Check sandbox mode**: Ensure `FYERS_SANDBOX` matches your token type
3. **Verify token format**: Should start with `eyJ0eXAiOiJKV1Qi`

---

## 🎯 Best Practices

### 1. Set Calendar Reminder
- Set a monthly reminder for token renewal
- Renew 1-2 days before 30-day mark
- Prevents unexpected downtime

### 2. Monitor Logs
- Check logs daily for refresh status
- Look for "TOKEN REFRESH SUCCESSFUL"
- Alert on failures

### 3. Use Telegram Alerts
- Configure Telegram bot for notifications
- Get alerted when refresh fails
- Remote monitoring capability

### 4. Backup Tokens
- Keep tokens in secure password manager
- Store previous refresh tokens as backup
- Document renewal dates

### 5. Test in Sandbox First
- Always test token renewal in sandbox mode
- Verify refresh works before going live
- Practice manual renewal process

---

## 📈 Production Deployment

### Render Configuration

1. **Environment Variables** (Render Dashboard):
   ```
   FYERS_CLIENT_ID=your_client_id
   FYERS_SECRET_KEY=your_secret_key
   FYERS_ACCESS_TOKEN=your_access_token
   FYERS_REFRESH_TOKEN=your_refresh_token  ← Don't forget!
   FYERS_SANDBOX=false  # for live trading
   ```

2. **Scheduler**: Daemon mode auto-starts token refresh job

3. **Logs**: Check Render logs for daily refresh confirmation

### Railway Configuration

Same as Render - add all environment variables in Railway dashboard.

---

## 🔐 Security Considerations

### Token Storage

- ✅ **DO**: Store tokens in environment variables
- ✅ **DO**: Use .env file (with .gitignore)
- ✅ **DO**: Set .env permissions to 600 or 644
- ❌ **DON'T**: Commit tokens to version control
- ❌ **DON'T**: Share tokens publicly
- ❌ **DON'T**: Hardcode tokens in source code

### Token Rotation

- Tokens rotate automatically every 12 hours (access token)
- Refresh token rotates every 30 days (manual)
- Old tokens are invalidated on refresh
- No token reuse - each refresh generates new tokens

### Access Control

- Limit access to .env file
- Use separate tokens for dev/prod
- Revoke tokens immediately if compromised
- Monitor API usage for suspicious activity

---

## 📚 Technical Details

### Refresh API Endpoint

```python
# FYERS API v3 refresh endpoint
url = "https://api.fyers.in/api/v3/validate-refresh-token"  # Live
url = "https://api-t1.fyers.in/api/v3/validate-refresh-token"  # Sandbox

payload = {
    "grant_type": "refresh_token",
    "appIdHash": sha256(client_id + ":" + secret_key),
    "refresh_token": "your_refresh_token",
    "pin": ""  # Not required for refresh
}
```

### App ID Hash Generation

```python
import hashlib

def get_app_id_hash(client_id: str, secret_key: str) -> str:
    """Generate FYERS app ID hash."""
    raw = f"{client_id}:{secret_key}"
    return hashlib.sha256(raw.encode()).hexdigest()
```

### Response Format

**Success**:
```json
{
    "s": "ok",
    "access_token": "eyJ0eXAiOiJKV1Qi...",
    "refresh_token": "new_refresh_token_if_rotated"
}
```

**Error**:
```json
{
    "s": "error",
    "code": -16,
    "message": "Invalid refresh token"
}
```

---

## 📞 Support

### Resources

- **FYERS API Docs**: https://myapi.fyers.in/docsv3
- **Developer Portal**: https://myapi.fyers.in/dashboard/
- **Support Email**: api@fyers.in

### Common Questions

**Q: How often should I manually renew?**
A: Once every 30 days (when refresh token expires)

**Q: Can I renew before 30 days?**
A: Yes, anytime. Early renewal is recommended.

**Q: What happens if I forget to renew?**
A: System falls back to MockExchange (simulated trades only)

**Q: Do I need to stop the engine to renew?**
A: No for .env updates, but restart recommended for environment reload

**Q: Can I automate the 30-day renewal?**
A: No - FYERS requires interactive OAuth for security

---

## ✅ Success Checklist

- [ ] FYERS credentials configured in .env
- [ ] Both access_token AND refresh_token set
- [ ] Token refresh tested with `--test` flag
- [ ] Scheduler running with token refresh job
- [ ] Daily refresh logs showing success
- [ ] Calendar reminder set for 30-day renewal
- [ ] Telegram alerts configured (optional)
- [ ] Documentation reviewed and understood

---

## 🎉 Summary

With automatic token refresh:
- **30 days** of autonomous operation
- **1 manual renewal** per month
- **Daily automatic refresh** at 08:45 IST
- **Zero downtime** during refresh
- **Production-ready** deployment

The system is now truly autonomous for institutional-grade 24/7 trading! 🚀

---

**Last Updated**: 2025-10-21  
**Version**: 2.0.0 (FYERS-First Edition with Auto-Refresh)  
**Status**: ✅ Production Ready
